apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Adds namespace to all resources.
namespace: kube-system

# Value of this field is prepended to the
# names of all resources, e.g. a deployment named
# "wordpress" becomes "alices-wordpress".
# Note that it should also match with the prefix (text before '-') of the namespace
# field above.
namePrefix: aws-load-balancer-

# Labels to add to all resources and selectors.
commonLabels:
  app.kubernetes.io/name: aws-load-balancer-controller

resources:
  - ../crd
  - ../rbac
  - ../controller
  # [PROMETHEUS] To enable prometheus monitor, uncomment all sections with 'PROMETHEUS'.
  #- ../prometheus

components:
  # To disable the conversion webhook, comment out this component
  - ../webhook
  # To disable cert-manager comment out the following line, the 'webhook' component is required
  - ../certmanager

replacements:
  # The following patches adds a directive for certmanager to inject CA into the CRD
  # CRD conversion requires k8s 1.13 or later.
  - source:
      kind: Certificate
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: CustomResourceDefinition
          name: (targetgroupbindings|ingressclassparams).elbv2.k8s.aws
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: /
      - select:
          kind: MutatingWebhookConfiguration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: /
      - select:
          kind: ValidatingWebhookConfiguration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: /
  - source:
      kind: Certificate
      fieldPath: metadata.name
    targets:
      - select:
          kind: CustomResourceDefinition
          name: (targetgroupbindings|ingressclassparams).elbv2.k8s.aws
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: /
          index: 1
      - select:
          kind: MutatingWebhookConfiguration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: /
          index: 1
      - select:
          kind: ValidatingWebhookConfiguration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: /
          index: 1
  # Patch dnsNames in webhook Service
  - source:
      kind: Service
      fieldPath: metadata.name
    targets:
      - select:
          kind: Certificate
          name: serving-cert
        fieldPaths:
          - spec.dnsNames.*
        options:
          delimiter: .
  - source:
      kind: Service
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: Certificate
          name: serving-cert
        fieldPaths:
          - spec.dnsNames.*
        options:
          delimiter: .
          index: 1
